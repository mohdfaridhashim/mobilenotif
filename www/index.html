<!DOCTYPE html>
<html lang="en">
<head>
<title>Bootstrap Example</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
<!-- Font Awesome -->
<link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
<!-- Ionicons -->
<link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css">
<style>
body
{
	height:-webkit-fill-available;
}
.theme
{
	background:linear-gradient(45deg, #04559c, #4dadef, #3ba8f3, #0370b9);
}
.loading-div
{
    position: absolute;
    background-color: rgba(255, 255, 255, 0.5);
    height: 100%;
    width: 100%;
    z-index: 99;
}
.loading-spinner
{
    top: 50%;
    left: 48%;
    color: #0159a5 !important;
	position: absolute;
}
.form-control, .form-control:focus
{
	background-color: transparent !important;
    border: none !important;
	border-bottom: 0.1px solid white !important;
    border-radius: unset !important;
	-webkit-box-shadow: none !important;
	-moz-box-shadow: none !important;
	box-shadow: none !important;
	padding-top: 25px !important;
	margin-left: 5px;
	color: white !important;
}
input::placeholder
{
  color: white !important;
}
.input-group-addon, .input-group-addon:focus
{
	background-color: transparent !important;
	border: none !important;
	border-radius: unset !important;
}
.fa-user-o, .fa-key {
  color: white;
    position: absolute;
    margin-left: -20px;
}
.fa-sign-in {
    position: inherit;
    margin-left: 0px;
	padding-right: 10px;
}
.btn-primary, .btn-primary:focus
{
	margin-top: 25px !important;
    border-radius: 100px !important;
    color: #fff !important;
    background-color: #004988 !important;
    border-color: #2682d4 !important;
	outline: none !important;
}
.header-title
{
    color: white;
    font-weight: bold;
    font-size: 30px;
}
.header-menu-left, .header-menu-right
{
	border-radius: 0px;
    width: 50%;
	margin-top: -10px;
    padding: 10px 0px;
}
.chat-list
{
	background-color: #ffffff;
    height: calc(100vh - 117px);
}
.row
{
  margin-left: 0px;
  margin-right: 0px;
}
.form-signin
{
    max-width: 330px;
    padding: 15px;
    margin: 0 auto;
}
.form-signin .form-signin-heading, .form-signin .checkbox
{
    margin-bottom: 10px;
}
.form-signin .checkbox
{
    font-weight: normal;
}
.form-signin .form-control
{
    position: relative;
    font-size: 16px;
    height: auto;
    padding: 10px;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
}
.form-signin .form-control:focus
{
    z-index: 2;
}
.form-signin input[type="text"]
{
    margin-bottom: -1px;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}
.form-signin input[type="password"]
{
    margin-bottom: 10px;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}
.account-wall
{
    margin-top: 20px;
    padding: 110px 0px 20px 0px;
}
.login-title
{
    color: white;
    font-size: 18px;
    font-weight: 400;
    display: block;
}
.profile-img
{
    width: 140px;
    height: 130px;
	background: rgba(255, 255, 255, 0.52);
    margin: 0 auto 10px;
    display: block;
    -moz-border-radius: 50%;
    -webkit-border-radius: 50%;
    border-radius: 50%;
	background-image: url(img/polis.png);
    background-size: 110px 110px;
    background-repeat: no-repeat;
    background-position: center;
	margin-bottom: 70px;
}
.need-help
{
    margin-top: 10px;
}
.new-account
{
    display: block;
    margin-top: 10px;
}
.friend-list {
  list-style: none;
  margin-left: -40px;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.friend-list li {
  border-bottom: 1px solid #eee;
}

.friend-list li a img {
  float: left;
  width: 45px;
  height: 45px;
  margin-right: 0px;
}

 .friend-list li a {
  position: relative;
  display: block;
  padding: 10px;
  transition: all .2s ease;
  -webkit-transition: all .2s ease;
  -moz-transition: all .2s ease;
  -ms-transition: all .2s ease;
  -o-transition: all .2s ease;
}

.friend-list li.active a {
  background-color: #f1f5fc;
}

.friend-list li a .friend-name, 
.friend-list li a .friend-name:hover {
  color: #777;
}

.friend-list li a .last-message {
  width: 65%;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

.friend-list li a .time {
  position: absolute;
  top: 10px;
  right: 8px;
}

.friend-list li a .chat-alert {
  position: absolute;
  right: 8px;
  top: 27px;
  font-size: 10px;
  padding: 3px 5px;
}
.btn-warning {
    color: #fff;
    background-color: #b7b4bd;
    border: none;
}
#messages 
{ 
  list-style-type: none; 
  margin: 0; padding: 0;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none; 
}
#messages li { padding: 5px 10px; }
#messages li:nth-child(odd) { background: #eee; }
#messages { margin-bottom: 40px }
</style>
<script src="js/socket.io-1.2.0.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
</head>
<body id="body-id" class="theme">
<div id="loading-div" class="row loading-div" style="display:none">
	<i class="fa fa-spinner fa-pulse fa-3x fa-fw loading-spinner"></i>
</div>
<div class="row col-xs-12 col-lg-12" id="navmenu" style="display: none; padding-bottom: 10px;">
<nav class="navbar">
      <div class="container-fluid">
        <div class="navbar-header">
          <h4 class="header-title">PDRM</h4>
        </div>
      </div>
  </nav>
  <div>
  <a href="#" id="listBTN" class="btn btn-info col-lg-6 col-xs-6 header-menu-left" role="button">
	<i class="fa fa-bars" aria-hidden="true">&nbsp List Chat</i>
  </a>
  <a href="#" id="logoutBTN" class="btn btn-warning col-lg-6 col-xs-6 header-menu-right" role="button">
	<i class="fa fa-sign-out" aria-hidden="true">&nbsp Logout</i>
  </a>
  </div>
</div>
<div class="row" id="loginform">
    <div class="container" >
        <div class="row">
            <div class="col-sm-12 col-md-12">
                <div class="account-wall">
                    <img class="profile-img">
                    <form class="form-signin">
					<div class="input-group">
						<span class="input-group-addon"><i class="fa fa-user-o"></i></span>
						<input type="text" id="username" class="form-control" placeholder="Email" required autofocus>
					</div>
					<div class="input-group">
						<span class="input-group-addon"><i class="fa fa-key"></i></span>
						<input type="password" id="password" class="form-control" placeholder="Password" required>
					</div>
                    <button id="login" class="btn btn-lg btn-primary btn-block" type="button">
                        <i class="fa fa-sign-in"></i> Sign in</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row" id="listchat" style="display:none;">
  <div class="row"></div>
  <div class="row chat-list">
      <ul class="friend-list" id="friend-list" ">
          <li class="active bounceInDown" >
              <a href="#" class="clearfix">
                  <img src="https://bootdey.com/img/Content/user_1.jpg" alt="" class="img-circle">
                  <div class="friend-name">   
                      <strong>John Doe</strong>
                  </div>
                  <div class="last-message text-muted">Hello, Are you there?</div>
                  <small class="time text-muted">Just now</small>
                  <small class="chat-alert label label-danger">1</small>
              </a>
          </li>
          <li>
              <a href="#" class="clearfix">
                  <img src="https://bootdey.com/img/Content/user_2.jpg" alt="" class="img-circle">
                  <div class="friend-name">   
                      <strong>Jane Doe</strong>
                  </div>
                  <div class="last-message text-muted">Lorem ipsum dolor sit amet.</div>
                  <small class="time text-muted">5 mins ago</small>
              <small class="chat-alert text-muted"><i class="fa fa-check"></i></small>
              </a>
          </li>                  
      </ul>
  </div>
</div>
<div class="row" id="chat" style="display:none">
    <div class="row"></div>
    <div class="row">
      <div class="panel panel-default">
          <div class="panel-heading top-bar">
            <h3 class="panel-title"><span class="glyphicon glyphicon-comment"></span> Chat Page</h3>
          </div>
          <div class="panel-body msg_container_base">
              <ul id="messages"></ul>
          </div>
      </div>
      <footer class="footer">
          <div class="input-group">
              <input type="hidden" name="sender" id="sender">
              <input type="hidden" name="receiver" id="receiver">
              <input type="hidden" name="conversation" id="conversation">
              <input id="m" type="text" autocomplete="off" class="form-control input-sm chat_input" placeholder="Write your message here">
              <span class="input-group-btn">
              <button id="sendText" class="btn btn-primary btn-sm">Send</button>
              <button id="refresh" class="btn btn-lg btn-primary btn-none" style="display:none" type="button">refresh</button>
              </span>
          </div>
      </footer>
    </div>
</div>

</body>
<script>
$(document).ready(function() {
    //if user already login it will redirect to 
    var socket = io('https://middleman-chat.herokuapp.com/');
    if(localStorage.getItem("auth")!=null){
        $("#loginform").css("display", "none");
        $("#listchat").css("display", "block");
        $("#navmenu").css("display", "block");
        socket.emit('login', localStorage.getItem("auth_req"));
    }else{
        $("#loginform").css("display", "block");
        $("#listchat").css("display", "none");
        $("#navmenu").css("display", "none");
        removeStorage();
    }
    if(localStorage.getItem("conversation_List")!=null){
        $('#friend-list').html(localStorage.getItem("conversation_List"));
    }
    $('#login').click(function() {
        var req = JSON.stringify({ email: $("#username").val(), pwd: $("#password").val() });
        localStorage.setItem('auth_req',req);
        socket.emit('login', req);
		$("#loading-div").show();
    });
    $('#listBTN').on('click', function(event){
      event.preventDefault(); 
      $("#loginform").css("display", "none");
      $("#listchat").css("display", "block");
      $("#navmenu").css("display", "block");
      $("#chat").css("display", "none");
      socket.emit('conversation_List',localStorage.getItem("auth"));
    });
    $('#refresh').on('click', function(event) {
      socket.emit('chatPage', localStorage.getItem("cid"));
    });
    $('#logoutBTN').on('click', function(event) {
      event.preventDefault(); 
      $("#loginform").css("display", "block");
      $("#listchat").css("display", "none");
      $("#navmenu").css("display", "none");
      $("#chat").css("display", "none");
      removeStorage();
    });
    //send message
    $('#sendText').on('click', function(event) {
      event.preventDefault();
      var message = JSON.stringify({ sender: $("#sender").val(),receiver: $("#receiver").val(),conversation: $("#conversation").val(),msg: $('#m').val() });
      socket.emit('chatting', message);
      $('#m').val('');
    });
    //socket event
    socket.on('login', function(msg){
      console.log(msg);
      if(msg != 'invalid authentication'){
        var detail = JSON.parse(msg);
        if(detail.statusCODE=='1'){
          localStorage.setItem("auth", msg);
          $("#loginform").css("display", "none");
          $("#listchat").css("display", "block");
          $("#navmenu").css("display", "block");
          socket.emit('conversation_List',msg);
        }else{
            alert('invalid authentication');
        }
      }
	  $("#loading-div").hide();
    });
    socket.on('conversation_List', function(msg){
      localStorage.setItem('conversation_List',msg);
      $('#friend-list').html(msg);
    });
    socket.on('chatting', function(msg){
      var extrt = JSON.parse(msg);
      console.log(extrt);
      if(extrt.type=="receive"){
        $('#messages').append('<li class="col-xs-12 col-lg-12"><span class="pull-right">'+extrt.msg+' <small>'+extrt.to+'</small></span></li>');
      }else{
        $('#messages').append('<li class"col-xs-12 col-lg-12" ><span class"pull-left">'+extrt.msg+' <small>'+extrt.to+'</small></span></li>');
      }
      window.scrollTo(0, document.body.scrollHeight);
      socket.emit('conversation_List',localStorage.getItem("auth"));
    });
    socket.on('chatPage', function(msg){
      $('#messages').html(msg);
      window.scrollTo(0, document.body.scrollHeight);
    });

    function removeStorage(){
      localStorage.removeItem("auth");
      localStorage.removeItem("auth_req");
      localStorage.removeItem("auth");
    }
});
function chatPage(uid,ruid,cid){
  $("#loginform").css("display", "none");
  $("#listchat").css("display", "none");
  $("#navmenu").css("display", "block");
  $("#chat").css("display", "block");
  $("#sender").val(uid);
  $("#receiver").val(ruid);
  $("#who").val(ruid);
  $("#conversation").val(cid);
  localStorage.setItem('cid',cid);
  $("#refresh").click();
}
</script>
</html>